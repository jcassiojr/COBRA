---
title: "Análise de Custo de SMS - Agência de Cobrança - DRAFT"
author: "José Cassio"
date: "Março 23, 2016"
output:
  html_document
---

![agileBIGDATA](./aBIG5.png)

Este documento descreve a análise de custo de SMS realizada com o objetivo de reduzir os custos de SMS da **Agência de Cobrança Asserth**, baseado em dados de cobrança da Avon.

#### Perído Analisado ####

Foram analisados os envios de SMS a clientes da carteira Avon enviados entre 01/07/2015 e 31/08/2015.

#### Estratégia da Análise ####

A partir de dados da carteira da Avon e de pagamentos efetuados, foi analisada a correlação entre os SMSs com confirmação de recebimento e pagamentos efetuados. Ou seja, a relação entre os SMSs confirmados e pagamentos detectados.

#### Resultados Obtidos ####

A partir das análises, foi verificado que o prazo médio entre o envio do SMS e a deteção de pagamentos é de aproximadamente 10 dias

```{r,echo=FALSE}
require("doMC")
require("dplyr")

source("~/Documents/MyGit/COBRA/R/f_ccf_sms_pgto.R")
source("~/Documents/MyGit/COBRA/R/f_le_sms.R")
source("~/Documents/MyGit/COBRA/R/f_nacion_reg.R")

registerDoMC(5) # parallel processing
options(scipen=999) # removendo display de notação científica em R


```

```{r,echo=FALSE}
# LE arquivos SMS
##########################################
df_sms.2015 <- f_le_sms()
# transformando em caracter o celular
df_sms.2015 <-
    df_sms.2015 %>%
    mutate(Celular = as.character(Celular))
# eliminando números esquisitos: terminados em 0000
df_sms.2015 <-
    df_sms.2015 %>%
    filter(!grepl("0000$",Celular))
#eliminando Enviado.Em com "-"
df_sms.2015 <-
    df_sms.2015 %>%
    filter(!(grepl("-", Enviado.em)))

# eliminando não recebidos e bloqueados
df_sms.2015 <-
    df_sms.2015 %>%
    filter(!(grepl("Não Recebido|Bloqueado",Status)))

# preparando formato correto de datas para plot
df_sms.2015$Enviado.em <- as.Date(df_sms.2015$Enviado.em, "%d/%m/%Y")

# chama funcao passando o numero de acionamentos de sms desejado por celular
nr.sms  <- 0 # número de acionamentos por celular para filtrar os dados. Se zero, seleciona tudo
my.list <- f_ccf_sms_pgto(df_sms.2015, nr.sms)

# CROSS CORRELATIONS
par(mfrow=c(1,3))
ccf(my.list[[5]]$acions.dia ,my.list[[5]]$pgto.dia, 
    na.action = na.pass, lag.max = 30, ylim = c(-0.1, 0.5), main = paste0("SMS NÃO Confirmado - ", nr.sms, " acionamentos"))

ccf(my.list[[6]]$acions.dia ,my.list[[6]]$pgto.dia, 
    na.action = na.pass, lag.max = 30, ylim = c(-0.1, 0.5), main = paste0("SMS Confirmado - ", nr.sms, " acionamentos"))

ccf(my.list[[7]]$acions.dia ,my.list[[7]]$pgto.dia, 
    na.action = na.pass, lag.max = 30, ylim = c(-0.1, 0.5), main = paste0("SMS Total - ", nr.sms, " acionamentos"))

#knitr::kable(head(df_acion))
```

#### Melhor Número de Acionamento por Celular ####

Os dados da análise mostraram que o melhor resultado de pagamentos foram obtidos com cerca de 8 a 9 SMSs enviados para cada celular, conforme mostrado no gráfico abaixo.


```{r,echo=FALSE}
    # numero de sms por celular
    df_sms.2015.cel <-
        df_sms.2015 %>%
        group_by(Celular) %>%
        summarise(acions.cel = n())
    
    #boxplot(df_sms.regiao.mn$acions.cel)
    #hist(df_sms.regiao.mn$acions.cel)
    #summary(df_sms.regiao.mn)
    # loop para gerar lista de 1 a 15 acionamentos
    #max.nacion <- 15
    my.f_max_corr <- data.frame()
    
    for(i in 1:nacion.max.in) {
        my.list <- f_ccf_sms_pgto(df_sms.2015, i)
        my.ccf <- ccf(my.list[[6]]$acions.dia ,my.list[[6]]$pgto.dia, 
                      na.action = na.pass, lag.max = 30, ylim = c(-0.1, 0.5), 
                      plot = FALSE)
        
        my.v_corr <- as.numeric(my.ccf$acf)
        my.v_lag <- as.numeric(my.ccf$lag)
        my.df_corr <- as.data.frame(cbind(lag = my.v_lag, corr = my.v_corr)) #data.frame com lags
        my.df_corr <-
            my.df_corr %>%
            filter(lag < 0)
        my.df_max_corr <- rbind(my.df_max_corr,my.df_corr [which.max(my.df_corr[,2]),])    
    }
    
    my.df_max_corr <-
        my.df_max_corr %>%
        mutate(n.acion = seq(1:dim(my.df_max_corr)[1]))
    
    # plot de maiores correlações por lag
    # FALTE DEFINIR O CONCEITO IMPORTANTE AQUI
    # é importante saber quais os nro acionamentos tem maior correlacao com pgto (plot2)
    # e quais lags tem maior correlaçao com pgto. Portanto, plot lag x corr
    # IMPORTANTE: DESCOBRI CORRELACAO ENTRE corr e n.acions!!! tem sentido (ver abaixo!!!)
    # a correlaçao mede o quanto o pagto está relacionado ao acionamento. Se a corr está correlacionada ao
    # nro de acionamentos, podemos confirmar que quanto mais mandamos sms conformado mais forte a
    # correlacao com pgto efetuado!!!!!
    my.lm.n.acion <- lm(my.df_max_corr$corr ~ my.df_max_corr$n.acion)
    #summary(my.lm.n.acion) # r-squared = 78% !!!!!
    #plot da correlação
    #plot(my.df_max_corr)
    sprintf("R Squared: %f", my.lm.n.acion$qr)
    
    # do plot acima, a corr.lag mostra onde lag se concentra para maior correlação n.acion x prim. pgto
    
    # E LAG x CORR mostra clusterização entre -15 e -20 dias!!!!!
    # Elaborar acima na apresentação e no post˜˜˜
    
    #pl_max_lag <- ggplot(my.df_max_corr, aes(lag, corr)) +
    #    geom_line() + 
        #geom_smooth() +
    #    xlab("lag") + ylab("correlação") + 
    #    ggtitle("Máximo de Pgtos - SMS confirmados-SP") 
    #ylim(c(min(my.df_max_corr$corr),max(my.df_max_corr$corr)))
    #heatmap.2(as.matrix(my.df_max_corr[,1:2]))
    # plot de maiores correlações x nro de acionamentos

    pl_max_acion <- ggplot(my.df_max_corr, aes(n.acion, corr)) + geom_line() + geom_smooth() +
        xlab("# acionamentos") + ylab("correlação") + 
        ggtitle("Máximo de Pgtos - SMS confirmados-SP") 
(pl_max_acion)
```
